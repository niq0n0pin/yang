name: Database Backup (ä½¿ç”¨ Environment Variables)

on:
  schedule:
    - cron: '0 14 * * *'  # UTC 14:00 (åŒ—äº¬æ—¶é—´ 22:00)
  workflow_dispatch:

# æŒ‡å®šä½¿ç”¨å“ªä¸ªç¯å¢ƒ
env:
  ENVIRONMENT: production

jobs:
  backup:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒ
    environment: production
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” æ£€æŸ¥ Environment Variables
        run: |
          echo "=== Environment Variables çŠ¶æ€ ==="
          echo "è¿è¡Œç¯å¢ƒ: ${{ vars.ENVIRONMENT || 'æœªè®¾ç½®' }}"
          echo "CRON_SECRET æ˜¯å¦å­˜åœ¨: ${{ vars.CRON_SECRET && 'âœ… å·²è®¾ç½®' || 'âŒ æœªè®¾ç½®' }}"
          
          if [ -n "${{ vars.CRON_SECRET }}" ]; then
            echo "CRON_SECRET é•¿åº¦: ${#CRON_SECRET}"
            echo "CRON_SECRET å‰4ä½: ${CRON_SECRET:0:4}"
          fi
          
          # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ç¯å¢ƒå˜é‡
          echo -e "\nğŸ“‹ å¯ç”¨ç¯å¢ƒå˜é‡:"
          echo "ENVIRONMENT: $ENVIRONMENT"
          # å…¶ä»–ç¯å¢ƒå˜é‡...
          
      - name: ğŸ“¡ å‘é€å¤‡ä»½è¯·æ±‚
        env:
          API_URL: https://yang-eight-sigma.vercel.app/api/cron-backup
          # ç›´æ¥ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆGitHubä¼šè‡ªåŠ¨æ³¨å…¥ï¼‰
        run: |
          echo "=== å‘é€å¤‡ä»½è¯·æ±‚ ==="
          echo "API åœ°å€: $API_URL"
          echo "Environment: $ENVIRONMENT"
          echo ""
          
          # æ„å»ºè¯·æ±‚
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            "$API_URL" \
            -H "Authorization: Bearer ${{ vars.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "X-Environment: $ENVIRONMENT" \
            -H "X-GitHub-Run-ID: ${{ github.run_id }}" \
            -d "{
              \"action\": \"backup\",
              \"source\": \"github-actions\",
              \"environment\": \"$ENVIRONMENT\",
              \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",
              \"run_id\": \"${{ github.run_id }}\"
            }")
          
          # è§£æå“åº”
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹:"
          echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… å¤‡ä»½è¯·æ±‚æˆåŠŸ"
          else
            echo "âŒ å¤‡ä»½è¯·æ±‚å¤±è´¥"
            exit 1
          fi
          
      - name: ğŸ“Š ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "=== å¤‡ä»½ä»»åŠ¡æŠ¥å‘Š ==="
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "ä½¿ç”¨ç¯å¢ƒ: $ENVIRONMENT"
          echo "æ‰§è¡Œç»“æœ: ${{ job.status }}"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "- GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Vercel é¡¹ç›®: https://vercel.com/niq0n0pins-projects/yang-eight-sigma"
