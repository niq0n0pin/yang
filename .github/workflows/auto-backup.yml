name: Daily Database Backup

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 22:00 è¿è¡Œï¼ˆUTC 14:00ï¼‰
    - cron: '0 14 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'ä»…æµ‹è¯•ä¸æ‰§è¡Œå®é™…å¤‡ä»½'
        required: false
        default: false
        type: boolean

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” éªŒè¯ç¯å¢ƒå˜é‡
        id: verify-secrets
        run: |
          echo "=== ç¯å¢ƒéªŒè¯å¼€å§‹ ==="
          echo "å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          
          # æ£€æŸ¥å¯†é’¥æ˜¯å¦å­˜åœ¨
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ é”™è¯¯: CRON_SECRET æœªè®¾ç½®"
            echo "è¯·åˆ° GitHub ä»“åº“è®¾ç½®:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo ""
            echo "å¯†é’¥åç§°: CRON_SECRET"
            echo "å¯†é’¥å€¼: (åœ¨ Vercel ä¸­è®¾ç½®çš„ç›¸åŒå€¼)"
            exit 1
          fi
          
          # æ˜¾ç¤ºå¯†é’¥ä¿¡æ¯ï¼ˆå®‰å…¨åœ°ï¼‰
          SECRET="${{ secrets.CRON_SECRET }}"
          echo "âœ… CRON_SECRET å·²è®¾ç½®"
          echo "å¯†é’¥é•¿åº¦: ${#SECRET} å­—ç¬¦"
          echo "å¯†é’¥æ ¼å¼: ${SECRET:0:4}...${SECRET: -4}"
          echo ""
          
          # éªŒè¯å¯†é’¥æ ¼å¼
          if [[ ! "$SECRET" =~ ^[a-zA-Z0-9]+$ ]]; then
            echo "âš ï¸  è­¦å‘Š: å¯†é’¥åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œè¯·ç¡®ä¿æ²¡æœ‰å¤šä½™ç©ºæ ¼"
          fi
          
          echo "âœ… ç¯å¢ƒéªŒè¯é€šè¿‡"
          
        continue-on-error: false
      
      - name: ğŸ“¡ å‘é€å¤‡ä»½è¯·æ±‚
        id: backup-request
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          API_URL: https://yang-eight-sigma.vercel.app/api/cron-backup
          IS_DRY_RUN: ${{ github.event.inputs.dry-run }}
        run: |
          echo "=== å¤‡ä»½è¯·æ±‚å¼€å§‹ ==="
          echo "ç›®æ ‡ API: $API_URL"
          echo "è¯·æ±‚æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "æ‰‹åŠ¨è§¦å‘: ${{ github.event_name == 'workflow_dispatch' }}"
          echo "æµ‹è¯•æ¨¡å¼: $IS_DRY_RUN"
          echo ""
          
          # æ„å»ºè¯·æ±‚æ•°æ®
          REQUEST_DATA=$(cat <<EOF
          {
            "action": "backup",
            "trigger": {
              "source": "github-actions",
              "event": "${{ github.event_name }}",
              "workflow": "${{ github.workflow }}",
              "run_id": "${{ github.run_id }}",
              "dry_run": $IS_DRY_RUN
            },
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF
          )
          
          echo "è¯·æ±‚æ•°æ®:"
          echo "$REQUEST_DATA" | jq '.' 2>/dev/null || echo "$REQUEST_DATA"
          echo ""
          
          # å‘é€è¯·æ±‚å¹¶æ•è·å“åº”
          echo "å‘é€å¤‡ä»½è¯·æ±‚..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            "$API_URL" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Backup/1.0 (${{ github.repository }})" \
            -H "X-GitHub-Run-ID: ${{ github.run_id }}" \
            -H "X-GitHub-Trigger: ${{ github.event_name }}" \
            -d "$REQUEST_DATA")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo ""
          echo "=== å“åº”è¯¦æƒ… ==="
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹:"
          echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
          echo ""
          
          # ä¿å­˜å“åº”åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "BACKUP_RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "BACKUP_HTTP_CODE=$HTTP_CODE" >> $GITHUB_ENV
          echo "REQUEST_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          
          # å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œé€€å‡º
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ å¤‡ä»½è¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : $HTTP_CODE)"
            exit 1
          fi
          
          echo "âœ… å¤‡ä»½è¯·æ±‚å‘é€æˆåŠŸ"
          
        continue-on-error: false
      
      - name: ğŸ“Š è§£æå¤‡ä»½ç»“æœ
        id: parse-result
        env:
          BACKUP_RESPONSE: ${{ env.BACKUP_RESPONSE }}
        run: |
          echo "=== å¤‡ä»½ç»“æœåˆ†æ ==="
          
          # ä½¿ç”¨ jq è§£æ JSON å“åº”ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ grep
          if command -v jq &> /dev/null; then
            echo "ä½¿ç”¨ jq è§£æå“åº”..."
            STATUS=$(echo "$BACKUP_RESPONSE" | jq -r '.status // "unknown"')
            MESSAGE=$(echo "$BACKUP_RESPONSE" | jq -r '.message // "No message"')
            TIMESTAMP=$(echo "$BACKUP_RESPONSE" | jq -r '.timestamp // "unknown"')
            
            # å¦‚æœæœ‰è¯¦ç»†ä¿¡æ¯ï¼Œæå–å‡ºæ¥
            if echo "$BACKUP_RESPONSE" | jq -e '.details' > /dev/null 2>&1; then
              DETAILS=$(echo "$BACKUP_RESPONSE" | jq -c '.details')
            else
              DETAILS="{}"
            fi
            
            # è¾“å‡ºè§£æç»“æœ
            echo "å¤‡ä»½çŠ¶æ€: $STATUS"
            echo "å¤‡ä»½æ¶ˆæ¯: $MESSAGE"
            echo "å®Œæˆæ—¶é—´: $TIMESTAMP"
            
            # å¦‚æœæœ‰æ‘˜è¦ä¿¡æ¯ï¼Œæ˜¾ç¤º
            if echo "$DETAILS" | jq -e '.summary' > /dev/null 2>&1; then
              echo ""
              echo "ğŸ“‹ å¤‡ä»½æ‘˜è¦:"
              echo "$BACKUP_RESPONSE" | jq -r '.details.summary | to_entries[] | "  \(.key): \(.value)"'
            fi
            
          else
            # å›é€€åˆ°ç®€å•è§£æ
            echo "ä½¿ç”¨åŸºæœ¬è§£æ..."
            echo "åŸå§‹å“åº”:"
            echo "$BACKUP_RESPONSE"
            
            # æå–çŠ¶æ€ï¼ˆç®€å•æ–¹æ³•ï¼‰
            if echo "$BACKUP_RESPONSE" | grep -q '"status":"success"'; then
              STATUS="success"
            elif echo "$BACKUP_RESPONSE" | grep -q '"status":"error"'; then
              STATUS="error"
            else
              STATUS="unknown"
            fi
            
            echo "å¤‡ä»½çŠ¶æ€: $STATUS"
          fi
          
          # ä¿å­˜ç»“æœä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "BACKUP_STATUS=$STATUS" >> $GITHUB_ENV
          echo "BACKUP_MESSAGE=$MESSAGE" >> $GITHUB_ENV
          echo "BACKUP_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
        continue-on-error: true
      
      - name: ğŸ“§ å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: always()
        env:
          BACKUP_STATUS: ${{ env.BACKUP_STATUS || 'unknown' }}
          BACKUP_HTTP_CODE: ${{ env.BACKUP_HTTP_CODE }}
          REQUEST_TIMESTAMP: ${{ env.REQUEST_TIMESTAMP }}
        run: |
          echo "=== å¤‡ä»½æ‰§è¡Œæ€»ç»“ ==="
          echo ""
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $REQUEST_TIMESTAMP"
          echo "ğŸ·ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ”„ è¿è¡Œ ID: ${{ github.run_id }}"
          echo "ğŸ”§ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          echo "ğŸ“Š æ‰§è¡Œç»“æœ:"
          echo "HTTP çŠ¶æ€ç : $BACKUP_HTTP_CODE"
          echo "å¤‡ä»½çŠ¶æ€: $BACKUP_STATUS"
          echo ""
          
          if [ "${{ job.status }}" = "success" ] && [ "$BACKUP_STATUS" = "success" ]; then
            echo "âœ… å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          elif [ "${{ job.status }}" = "success" ] && [ "$BACKUP_STATUS" != "success" ]; then
            echo "âš ï¸  è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†å¤‡ä»½çŠ¶æ€æœªçŸ¥"
          else
            echo "âŒ å¤‡ä»½ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          fi
          
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "GitHub Actions è¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Vercel é¡¹ç›®: https://vercel.com/niq0n0pins-projects/yang-eight-sigma"
          
      - name: ğŸ å®Œæˆå¤‡ä»½ä»»åŠ¡
        if: always()
        run: |
          echo ""
          echo "ğŸ‰ å¤‡ä»½å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          echo "è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "è¿è¡Œæ—¶é•¿: ${{ job.status }}"
          echo ""
          echo "ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: æ¯å¤© UTC 14:00 (åŒ—äº¬æ—¶é—´ 22:00)"
